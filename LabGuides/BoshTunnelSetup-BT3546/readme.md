# Set up a bosh tunnel to be able to run bosh cli commands from the cli-vm

## Overview

The following lab guide provides the procedures to set up the cli-vm so that you can run bosh cli commands from there.  This would also enable the cli-vm to be a bbr jumpbox, in case you would want to execute a bbr backup or restore.

## Prerequisites

- Please see [Getting Access to a PKS Ninja Lab Environment](https://github.com/CNA-Tech/PKS-Ninja/tree/Pks1.4/Courses/GetLabAccess-LA8528) to learn about how to access or build a compatible lab environment

## Installation Notes

Anyone who implements any software used in this lab must provide their own licensing and ensure that their use of all software is in accordance with the software's licensing. This guide provides no access to any software licenses.

### Overview of Tasks Covered in this Lab Guide

- [Step 1: Set up the ssh keys between the cli-vm and the Ops Manager VM](#step-1-set-up-the-ssh-keys-between-the-cli-vm-and-the-ops-manager-vm)
- [Step 2: Install the bosh cli](#step-2-install-the-bosh-cli)
- [Step 3: Set up the bosh tunnel](#step-3-set-up-the-bosh-tunnel)
- [Step 4: Run bosh commands](#step-4-run-bosh-commands)

-----------------------

## Step 1: Set up the ssh keys between the cli-vm and the Ops Manager VM

Note: You should skip this step if you can already ssh from the cli-vm into the Ops Manager using a ssh key file and not using a password.  If you're using Ops Manager v2.6.x or above, then you probably have the ssh key as it is a requirement in that version.  If you already have the ssh key, then proceed to step 2.

1.0 From the `cli-vm`, run `ssh-keygen`.  When prompted to enter file name to save the key, enter `opsman-ssh-key`.  Press `Enter` on all other prompts.  Once the `ssh-keygen` has completed generating the keys, list the files generated by running `ls -l opsman-ssh-key*`.

<Details><Summary>Screenshot 1.0.1</Summary>
<img src="Images/2019-09-25-13-20-43.png">
</Details>
<br/>

<Details><Summary>Screenshot 1.0.2</Summary>
<img src="Images/2019-09-25-13-21-13.png">
</Details>
<br/>

1.1 Show the contents of the `opsman-ssh-key.pub` file by running `cat opsman-ssh-key.pub`.  Then, copy all of the contents.

<Details><Summary>Screenshot 1.1</Summary>
<img src="Images/2019-09-25-13-29-03.png">
</Details>
<br/>

1.2 Log in as the `ubuntu` user into the Ops Manager VM as you normally would.  Then, paste the contents you copied from step 1.1 into the `~/.ssh/authorized_keys` file.  You can do this via `cat >> ~/.ssh/authorized_keys` and then paste the contents of opsman-ssh-key.pub, then press Ctrl-D to end the input.

<details><summary>Screenshot 1.2</summary>
<img src="Images/2019-09-25-14-39-23.png">
</details>
<br/>

1.3 Test if you can ssh into the Ops Manager VM from the cli-vm just by using the ssh key file. Run `ssh -i opsman-ssh-key ubuntu@opsman.corp.local`.  You should be able to log in without using any password.

<details><summary>Screenshot 1.3</summary>
<img src="Images/2019-09-25-13-31-30.png">
</details>
<br/>


## Step 2: Install the bosh cli

In this step, you create a connection between the NSX manager and your vCenter. This enables NSX manager to deploy VIBs to the hosts, controller and edge VMs, etc.

 2.1 Click anywhere on the screen to skip the "Welcome to NSX-T" Screen, click on the `System` tab and then on the left navigation bar Click `Fabric`, and then click `Compute Managers`

<details><summary>Screenshot 2.1</summary>
<img src="Images/2019-08-12-23-36-45.png">
</details>
<br/>

 2.2 Click on **Add** and Configure the New Compute Manager form with following values:

- Name: `vcsa-01a`
- Domain Name/IP Address: `vcsa-01a.corp.local`
- Type: `vCenter`
- Username: `administrator@corp.local`
- Password: `VMware1!`
- Clcik **Add**
- Click **Add** again to accept the vCenter certificate thumbprint

_NOTE: in a production implementation, you would first copy the vCenter thumbprint and then provide it in the form to properly authenticate the intial connection._

<details><summary>Screenshot 2.2.1</summary>
<img src="Images/2019-08-12-23-37-30.png">
</details>

<details><summary>Screenshot 2.2.2</summary>
<img src="Images/2018-12-13-16-17-18.png">
</details>
<br/>

 2.3 Click **Refresh** in the lower-left hand corner and verify the Compute Manager is `Registered` and `Up`

<details><summary>Screenshot 2.3.1</summary>
<img src="Images/2018-12-16-16-54-09.png">
</details>

<details><summary>Screenshot 2.3.2</summary>
<img src="Images/2019-08-12-23-38-16.png">
</details>
<br/>

## Step 3: Set up the bosh tunnel

 3.1 From the NSX-T Manager UI navigate to the `Advanced Networking & Security > Inventory > Groups > IP Pools` page and click `+ADD` 

<details><summary>Screenshot 3.1</summary>
<img src="Images/2019-07-13-01-25-39.png">
</details>
<br/>

 3.2 On the `Add IP Pool` screen, enter the following values:

- Name: `tep-ip-pool`
- Click `Add` under Subnets
- IP Range: `192.168.130.51-192.168.130.75`
- Gateway: `192.168.130.1`
- CIDR: `192.168.130.0/24`
- DNS Servers:  `192.168.110.10`
- DNS Suffix: `Corp.local`
- Click **Add**

<details><summary>Screenshot 3.2</summary>
<img src="Images/2019-07-13-01-31-28.png">
</details>
<br/>

 3.3 From the NSX-T Manager Homepage at the bottom of the `System` section, click `Get Started`, and then click `Setup Transport Nodes`

<details><summary>Screenshot 3.3</summary>
<img src="Images/2019-07-13-01-35-19.png">
</details>
<br/>

 3.4 On the `Select Node Type` screen, select `NSX Edge VM` and click `Next`

<details><summary>Screenshot 3.4</summary>
<img src="Images/2019-07-13-01-36-49.png">
</details>
<br/>

 3.5 On the `Select NSX Edge` Screen, click `Add New Edge`

<details><summary>Screenshot 3.5</summary>
<img src="Images/2019-07-13-01-38-30.png">
</details>
<br/>

 3.6 Complete the Add Edge VM workflow with the following values:

 - Name: nsxedge-1
 - FQDN: nsxedge-1.corp.local   
 - Form Factor: Large
 - Click Next
 - CLI Password: VMware1!VMware1!
 - System Root Password: VMware1!VMware1!
 - Compute Manager: vcsa-01a
 - Cluster: RegionA01-MGMT01
 - Datastore: RegionA01-ISCSI02-COMP01
 - Click Next
 - Management: VM-RegionA01-vDS-MGMT
 - Select "Static" (not DHCP)
 - Management IP: 192.168.110.91/24
 - Gateway IP: 192.168.110.1
 - fp-eth0: Uplink-RegionA01-vDS-MGMT
 - fp-eth1: Transport-RegionA01-vDS-MGMT
 - fp-eth2: VM-RegionA01-vDS-MGMT
 - Click Finish

<details><summary>Screenshot 3.6.1</summary>
<img src="Images/2019-08-12-23-48-01.png">
</details>

<details><summary>Screenshot 3.6.2</summary>
<img src="Images/2019-07-13-01-39-47.png">
</details>

<details><summary>Screenshot 3.6.3</summary>
<img src="Images/2019-07-13-01-40-18.png">
</details>

<details><summary>Screenshot 3.6.4</summary>
<img src="Images/2019-07-13-01-42-28.png">
</details>
<br/>

 3.7 The Wizard will deploy and attempt to power on the edge VM, but it will fail as there is no host with the capacity to run the edge in the lab. Log into vCenter, review the tasks pane to ensure the edge VM is finished deploying, wait as needed, and verify you can see the error message indicating that vCenter could not power on the edge vm. 

Navigate to the `Hosts and Clusters` view, select `nsxedge-1`. From the actions menu for `nsxedge-1` select `Edit Settings`.

**If you are using the Baseline-0.6 template or newer, set the CPU count to `8`. If you are using the Baseline-0.5 template or older, set the CPU count to `4`.** 

 Expand the `Memory` section, **uncheck** the box for `Reserve all guest memory (All Locked)`, set the `Reservation` value to `0 MB` and click `OK`

<details><summary>Screenshot 3.7.1</summary>
<img src="Images/2019-07-13-02-02-05.png">
</details>

<details><summary>Screenshot 3.7.2</summary>
<img src="Images/2019-07-13-02-03-04.png">
</details>
<br/>

After making the changes to the `nsxedge-1` VM, power the VM on via the vCenter UI.

 3.8 Return to the NSX UI and wait for the wizard to recognize the NSX Edge VM. This may take up to ~15 minutes, and you may need to refresh your connection to NSX Manager, if so you can use the same steps as above to get back to the `Setup Transport Nodes ` wizard. 
 
 On the `Select NSX Edge` screen select `nsxedge-1` from the `Edge Node` Pulldown Menu and click `Next` 

<details><summary>Screenshot 3.8</summary>
<img src="Images/2019-07-13-01-43-20.png">
</details>
<br/>

 3.9 On the `Select Transport Zone East-West` Screen, select `Create Overlay Transport Zone`

<details><summary>Screenshot 3.9</summary>
<img src="Images/2019-07-13-01-44-28.png">
</details>
<br/>

 3.10 In the `Add Transport Zone` workflow, enter the following values:

- Name: `overlay-tz`
- N-VDS Name: `hostswitch-overlay`
- Traffic Type: `Overlay`
- Click **Add** 

<details><summary>Screenshot 3.10</summary>
<img src="Images/2019-07-13-01-45-26.png">
</details>
<br/>

 3.11 On the `Select Transport Zone East-West` screen, select `overlay-tz` from the `Overlay Transport Zone` pulldown menu and click `Next` 

<details><summary>Screenshot 3.11</summary>
<img src="Images/2019-07-13-01-47-21.png">
</details>
<br/>

 3.12 On the `Select Uplink Profile East-West` screen, select `nsx-edge-single-nic-uplink-profile` from the `Select Uplink Profile` pulldown menu and click `Next`

<details><summary>Screenshot 3.12</summary>
<img src="Images/2019-07-13-01-47-52.png">
</details>
<br/>

 3.13 On the `Link to Transport Zone East-West` screen for `Assignment IP Address` select `Use IP Pool` and select `tep-ip-pool`

<details><summary>Screenshot 3.13</summary>
<img src="Images/2019-07-13-01-49-42.png">
</details>
<br/>


 3.14 On the `Link to Transport Zone East-West` screen in the `NSX Edge NIC Connections` section, set the value for `fp-eth1` to `uplink-1` and click `Next`

<details><summary>Screenshot 3.14</summary>
<img src="Images/2019-07-13-01-51-00.png">
</details>
<br/>

 3.15 On the `Select Transport Zone North-South` screen, click `Create VLAN Transport Zone`

<details><summary>Screenshot 3.15</summary>
<img src="Images/2019-07-13-01-51-49.png">
</details>
<br/>

 3.16 On the `Add Transport Zone` screen, add a transport zone with the following parameters:

 - Name: vlan-tz
 - N-VDS Name: hostswitch-vlan
 - Traffic Type: VLAN
 - Click **Add**

<details><summary>Screenshot 3.16</summary>
<img src="Images/2019-07-13-01-52-27.png">
</details>
<br/>

 3.17 On the `Select Transport Zone North-South` screen, select `vlan-tz` from the pulldown menu for `VLAN Transport Zone` and click `Next`

<details><summary>Screenshot 3.17</summary>
<img src="Images/2019-07-13-01-53-28.png">
</details>
<br/>

 3.18 On the `Select Uplink Profile North-South` screen, select `nsx-edge-single-nic-uplink-profile` from the `Select Uplink Profile` pulldown menu and click `Next`

<details><summary>Screenshot 3.18</summary>
<img src="Images/2019-07-13-01-54-11.png">
</details>
<br/>

 3.19 On the `Link To Transport Zone North-South` screen, leave the `Assignment IP Address` value blank/empty as shown in the screenshot below. In the `NSX Edge NIC Connections` section, set the value for `fp-eth0` to `uplink-1` and click `Next`

<details><summary>Screenshot 3.19</summary>
<img src="Images/2019-07-13-01-55-12.png">
</details>
<br/>

 3.20 On the `Add To NSX Edge Cluster` screen, select `Add To New NSX Edge Cluster (system created)` field, set the `NSX Edge Cluster Name` value to `edge-cluster-1` and click `Next`

<details><summary>Screenshot 3.20</summary>
<img src="Images/2019-07-13-01-56-26.png">
</details>
<br/>

 3.21 On the `Review` screen, set the `Transport Node Name` to `edge-tn-1` and click `Finish`

<details><summary>Screenshot 3.21</summary>
<img src="Images/2019-07-13-01-57-08.png">
</details>
<br/>

 3.22 On the `System` tab in NSX Manager UI, In the left navigation bar expand the `Fabric` section and select `Nodes`. Select the `Edge Transport Nodes` tab, verify that `edge-tn-1` has a `Configuration State` of `Success`, a `Node Status` of `Up`, and is a member of `edge-cluster-1`

<details><summary>Screenshot 3.22</summary>
<img src="Images/2019-07-13-02-01-04.png">
</details>
<br/>

 

## Step 4: Run bosh commands

Preparing hosts entails NSX Manager deploying and installing NSX VIBs (i.e.kernel modues) and configuring the NSX tunnel endpoints and participation in the N-VDS overlay fabric.

 4.1 From the NSX Manager UI go to the `System > Get Started` page and click `SET UP TRANSPORT NODES` 

<details><summary>Screenshot 4.1</summary>
<img src="Images/2019-07-13-01-35-19.png">
</details>
<br/>

 4.2 On the `Select Node Type` screen select `Host Cluster` and click `Next`

<details><summary>Screenshot 4.2</summary>
<img src="Images/2019-07-13-02-13-07.png">
</details>
<br/>

 4.3 On the `Select Host Cluster` Screen, set the value for `Host Cluster` to `RegionA01-COMP01`, when you make this selection, the page will prompt you to `Confirm Installation`, click `Install`. Do not proceed until the status in the `NSX` column for `esx-01a`, `esx-02a` and `esx-03a` is `NSX Installed`, and that `NSX Manager Connectivity` is `Up` for each host as shown in the screenshots below.

<details><summary>Screenshot 4.3.1</summary>
<img src="Images/2019-07-13-02-13-52.png">
</details>

<details><summary>Screenshot 4.3.2</summary>
<img src="Images/2019-07-13-02-14-14.png">
</details>

<details><summary>Screenshot 4.3.3</summary>
<img src="Images/2019-07-13-02-14-54.png">
</details>

<details><summary>Screenshot 4.3.4</summary>
<img src="Images/2019-07-13-02-18-39.png">
</details>
<br>

 4.4 On the `Select Transport Zone East-West` screen set the value for `Overlay Transport Zone` to `overlay-tz` and click `Next`

<details><summary>Screenshot 4.4</summary>
<img src="Images/2019-09-09-15-24-01.png">
</details>
<br/>

 4.5 On the `Select Uplink Profile East-West` screen, set the value for `Select Uplink Profile` to `nsx-default-uplink-hostswitch-profile` and click `Next`

<details><summary>Screenshot 4.5</summary>
<img src="Images/2019-07-13-02-19-49.png">
</details>
<br/>

 4.6 On the `Link to Transport Zone East-West` screen, set the value for `Assignment IP Address` to `Use IP Pool` and set the value for `IP Pool` to `tep-ip-pool`

<details><summary>Screenshot 4.6</summary>
<img src="Images/2019-07-13-02-21-31.png">
</details>
<br/>

 4.7 On the `Link to Transport Zone East-West` screen, in the `Host NIC Connections` section, set the value for `vmnic1` to `uplink-1` and click `Next`

<details><summary>Screenshot 4.7</summary>
<img src="Images/2019-07-13-02-22-12.png">
</details>
<br/>

 4.8 On the `Review` screen, click `Finish`

<details><summary>Screenshot 4.8</summary>
<img src="Images/2019-07-13-02-22-39.png">
</details>
<br/>

 4.9 From the NSX Manager UI go to the `System > Get Started` page and click `SET UP TRANSPORT NODES` 

<details><summary>Screenshot 4.9</summary>
<img src="Images/2019-07-13-01-35-19.png">
</details>
<br/>

 4.10 On the `Select Node Type` screen select `Host Cluster` and click `Next`

<details><summary>Screenshot 4.10</summary>
<img src="Images/2019-07-13-02-13-07.png">
</details>
<br/>

 4.11 On the `Select Host Cluster` Screen, set the value for `Host Cluster` to `RegionA01-MGMT01`, when you make this selection, the page will prompt you to `Confirm Installation`, click `Install`. Do not proceed until the status in the `NSX` column for `esx-04a`, `esx-05a` and `esx-06a` is `NSX Installed`, and that `NSX Manager Connectivity` is `Up` for each host as shown in the screenshots below.

<details><summary>Screenshot 4.11.1</summary>
<img src="Images/2019-07-13-02-23-56.png">
</details>

<details><summary>Screenshot 4.11.2</summary>
<img src="Images/2019-07-13-02-14-14.png">
</details>

<details><summary>Screenshot 4.11.3</summary>
<img src="Images/2019-07-13-02-24-53.png">
</details>

<details><summary>Screenshot 4.11.4</summary>
<img src="Images/2019-07-13-02-31-58.png">
</details>
<br>

 4.12 On the `Select Transport Zone East-West` screen set the value for `Overlay Transport Zone` to `overlay-tz` and click `Next`

<details><summary>Screenshot 4.12</summary>
<img src="Images/2019-07-13-02-32-37.png">
</details>
<br/>

 4.13 On the `Select Uplink Profile East-West` screen, set the value for `Select Uplink Profile` to `nsx-default-uplink-hostswitch-profile` and click `Next`

<details><summary>Screenshot 4.13</summary>
<img src="Images/2019-07-13-02-33-17.png">
</details>
<br/>

 4.14 On the `Link to Transport Zone East-West` screen, set the value for `Assignment IP Address` to `Use IP Pool` and set the value for `IP Pool` to `tep-ip-pool`

<details><summary>Screenshot 4.14</summary>
<img src="Images/2019-07-13-02-21-31.png">
</details>
<br/>

 4.15 On the `Link to Transport Zone East-West` screen, in the `Host NIC Connections` section, set the value for `vmnic1` to `uplink-1` and click `Next`

<details><summary>Screenshot 4.15</summary>
<img src="Images/2019-07-13-02-22-12.png">
</details>
<br/>

 4.16 On the `Review` screen, click `Finish`

<details><summary>Screenshot 4.16</summary>
<img src="Images/2019-07-13-02-22-39.png">
</details>
<br/>

 4.17 On the `System` tab in NSX Manager UI, In the left navigation bar expand the `Fabric` section and select `Nodes`. Select the `Host Transport Nodes` tab, set the `Managed by` field to `vcsa-01a`, expand the `RegionA01-MGMT01` and `RegionA01-COMP01` sections and ensure the `Configuration State` is `Success` and the `Node Status` is `Up` for all of the hosts

<details><summary>Screenshot 4.17</summary>
<img src="Images/2019-07-13-02-42-10.png">
</details>
<br/>


***End of lab***
